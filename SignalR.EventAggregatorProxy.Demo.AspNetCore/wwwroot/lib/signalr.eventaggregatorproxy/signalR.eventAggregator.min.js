(function(d){d.EventAggregator=function(e){this.constraintId=0;this.contextSubscriptions=new Map();this.eventSubscriptions=new Map();if(e){this.proxy=new c(this);}};d.EventAggregator.prototype=function(){function j(n,m){n=b(n);var l=m?n.constructor:n;if(!this.eventSubscriptions.has(l)){this.eventSubscriptions.set(l,[]);}return this.eventSubscriptions.get(l);}function f(m,l){return l==null||(m.constraintId===l);}function h(l,m){return a(l.type.genericArguments,m.type.genericArguments)&&f(l,m.constraintId);}function g(l,m){if(m===undefined){return false;}for(var o in l){var p=l[o];var q=m[o];var n=typeof p==="object";if(p!==q&&!n){return false;}if(n&&!g(p,q)){return false;}}return true;}function i(l){if(!this.contextSubscriptions.has(l)){this.contextSubscriptions.set(l,[]);}return this.contextSubscriptions.get(l);}function k(l){var n=j.call(this,l.type,false);if(b(l.type).proxyEvent!==true){return false;}if(n.length===0){return true;}if(l.type.genericArguments==null&&l.constraint==null){return false;}var m=true;n.every(function(o){if(l.type.genericArguments!=null&&!a(l.type.genericArguments,o.type.genericArguments)){return true;}if(l.constraint!=null&&!g(l.constraint,o.constraint)){return true;}m=false;l.constraintId=o.constraintId;return false;});return m;}function e(l){l.constraintId=l.constraint?this.constraintId++:null;}return{unsubscribe:function(m){if(!this.contextSubscriptions.has(m)){return;}var n=this.contextSubscriptions.get(m);var l=[];n.forEach(function(t){var q=-1;var u=j.call(this,t.type,false);for(var p=0;p<u.length;p++){if(u[p].context==m&&h(t,u[p])){q=p;break;}}if(q!=-1){var v=u.splice(q,1)[0];var o=false;for(var r=0;r<u.length;r++){if(h(v,u[r])){o=true;break;}}if(!o){l.push(v);}}}.bind(this));if(this.proxy){this.proxy.unsubscribe(l);}},subscribe:function(s,n,m,l){var r=i.call(this,m);var p=j.call(this,s,false);var q={type:s,handler:n,context:m,constraint:l};var o=k.call(this,q);r.push(q);p.push(q);if(this.proxy&&o){e.call(this,q);this.proxy.subscribe(b(s),s.genericArguments,l,q.constraintId);}},publish:function(n,m,l){var o=j.call(this,n,true);o.forEach(function(p){if(a(p.type.genericArguments,m)&&f(p,l)){p.handler.call(p.context,n);}});}};}();var c=function(e){this.eventAggregator=e;if(d.HubConnectionBuilder==null){throw"Ensure that SignalR client side library is included and before Signal.EventAggregator cilent library.";}this.hub=new d.HubConnectionBuilder().withUrl("/EventAggregatorProxyHub").build();this.hub.on("onEvent",this.onEvent.bind(this));this.queueSubscriptions=true;this.isConnected=false;this.queuedSubscriptions=[];this.activeSubscriptions=[];this.hub.onclose(this.start.bind(this));this.start();};c.prototype={start:function(){this.hub.start().catch(function(){setTimeout(this.start.bind(this),5000);}.bind(this)).then(this.isConnected?this.reconnected.bind(this):this.sendSubscribeQueue.bind(this));},onEvent:function(g){var h=d.getEvent(g.type);var e=new h();for(var f in g.event){e[f]=g.event[f];}this.eventAggregator.publish(e,g.genericArguments,g.id);},subscribe:function(g,h,e,f){if(g.proxyEvent!==true){return;}this.queuedSubscriptions.push({type:g.type,genericArguments:h,constraint:e,constraintId:f});if(!this.queueSubscriptions){clearTimeout(this.throttleTimer);this.throttleTimer=setTimeout(this.sendSubscribeQueue.bind(this),1);}},unsubscribe:function(e){var f=e.map(function(h){var g=b(h.type);if(g.proxyEvent!==true){return null;}return this.removeActiveSubscription({type:g.type,genericArguments:h.type.genericArguments,id:h.constraintId});}.bind(this)).filter(function(g){return g!==null;});if(f.length>0){this.queueSubscriptions=true;this.hub.invoke("Unsubscribe",f).then(this.sendSubscribeQueue.bind(this));}},removeActiveSubscription:function(h){for(var g=0;g<this.activeSubscriptions.length;g++){var f=this.activeSubscriptions[g];if(f.type===h.type&&a(f.genericArguments,h.genericArguments)&&f.constraintId===h.id){this.activeSubscriptions.splice(g,1);break;}}return h;},sendSubscribeQueue:function(e){var f=typeof(e)==="boolean"?e:false;this.isConnected=true;this.queueSubscriptions=false;if(this.queuedSubscriptions.length===0){return;}var g=this.queuedSubscriptions;this.queuedSubscriptions=[];this.pushRange(this.activeSubscriptions,g);this.hub.invoke("Subscribe",g,f);},pushRange:function(e,f){e.push.apply(e,f);},reconnected:function(){var e=this.activeSubscriptions;this.activeSubscriptions=[];this.queuedSubscriptions=e;this.sendSubscribeQueue(true);}};function b(e){return e.genericConstructor||e;}function a(e,f){if(e==null){return true;}if(e.length!==f.length){return false;}for(var g=0;g<f.length;g++){if(e[g]!==f[g]){return false;}}return true;}d.eventAggregator=new d.EventAggregator(true);})(window.signalR=window.signalR||{});